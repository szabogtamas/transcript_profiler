---
title: "`r params$report_title`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
    code_folding: hide
params:
  gene_symbol: "TP53"
  report_title: "Transciprts of `r params$gene_symbol`"
  report_author: "Tamas Szabo"
  report_time: !r format(Sys.Date(), format="%d/%m/%Y")
  report_folder: "../reports"
  figure_folder: "../figures"
  table_folder: "../tables"
  data_folder: "../data"
---

## Setup

```{r message = FALSE, warning = FALSE}
# Import tools to be used

library(dplyr)
library(msa)
library(seqLogo)
library(EnsDb.Hsapiens.v86)
library(EnsDb.Mmusculus.v79)
library(ensembldb)
library(homologene)
library(GenomicRanges)
library(GenomicFeatures)
library(Biostrings)
library(Gviz)
library(ggbio)
library(ggseqlogo)
library(ggmsa)
library(bios2mds)
library(DT)

select <- dplyr::select
filter <- dplyr::filter

for (dr in c('report_folder', 'figure_folder', 'table_folder', 'data_folder')){
  drn <- params[[dr]]
  if(!dir.exists(drn)) dir.create(drn, recursive=TRUE)
}
```

```{r}
hsdb <- EnsDb.Hsapiens.v86
mmdb <- EnsDb.Mmusculus.v79

hub_dir <- "work/hub"
if(!dir.exists(hub_dir)) dir.create(hub_dir, recursive=TRUE)
setAnnotationHubOption("CACHE", hub_dir)
hs_dna <- ensembldb:::getGenomeTwoBitFile(hsdb)
```

## Human transcripts

### Transcript annotations for gene

```{r}
Tx <- transcripts(
  hsdb, filter = GeneNameFilter(params$gene_symbol),
  columns = c("tx_biotype", "gene_name")#, "protein_id", "uniprot_id")
)
Tx <- Tx[Tx$tx_biotype != "LRG_gene"]
tx_df <- Tx %>%
  as.data.frame() %>%
  select(gene_name, chromosome=seqnames, start, end, tx_biotype)

datatable(tx_df)
```

```{r}
chr <- as.character(unique(seqnames(Tx)))
region_start = min(tx_df$start)
region_end = max(tx_df$end)

genome_location_track <- GenomeAxisTrack()
genome_region_range <- getGeneRegionTrackForGviz(
  hsdb, chromosome=chr, start=region_start, end=region_end,
  filter=AnnotationFilterList(
    GeneNameFilter(params$gene_symbol),
    GeneIdFilter("ENS", "startsWith")
  ), featureIs="tx_biotype"
)

genome_region_track <- GeneRegionTrack(
  genome_region_range, name="", transcriptAnnotation="transcript",
  background.title="white"
)

options(ucscChromosomeNames = FALSE)
plotTracks(list(genome_location_track, genome_region_track))
```

### Nucleotide sequences

```{r}
nt_seqs <- hsdb %>%
  exonsBy(
    by = "tx",
    filter = AnnotationFilterList(
      GeneNameFilter(params$gene_symbol),
      GeneIdFilter("ENS", "startsWith")
    )
  ) %>%
  extractTranscriptSeqs(hs_dna, .)

writeXStringSet(nt_seqs, file.path(params$data_folder, paste(params$gene_symbol, "nt_human.fa", sep="_")))

nt_seqs
```

### Protein sequences

```{r}
protein_seqs <- proteins(
  hsdb, return.type = "AAStringSet",
  filter = AnnotationFilterList(
    GeneNameFilter(params$gene_symbol),
    GeneIdFilter("ENS", "startsWith")
  )
)

writeXStringSet(protein_seqs, file.path(params$data_folder, paste(params$gene_symbol, "aa_human.fa", sep="_")))

protein_seqs
```

```{r}
alignment_fn <- file.path(params$data_folder, paste(params$gene_symbol, "msa_human.fa", sep="_"))

protein_seqs %>%
  msa() %>%
  msaConvert("bios2mds::align") %>%
  export.fasta(outfile=alignment_fn)

alignment_fn %>%
  readLines() %>%
  gsub("NA$", "", .) %>%
  writeLines(alignment_fn)

#msaPrettyPrint(aligned_prots, output="pdf", showNames="none", showLogo="none", askForOverwrite=FALSE, verbose=FALSE)
#print(aligned_prots, show="complete")

ggmsa(alignment_fn, start = 221, end = 280, char_width = 0.5, seq_name = T) +
  geom_seqlogo() +
  geom_msaBar()
```

```{r}
zz <- readAAStringSet(alignment_fn)
```


```{r}
aligned_prots %>%
  consensusMatrix(as.prob=TRUE) %>%
  seqLogo()
```

```{r}
p <- ggmsa(protein_seqs, start = 221, end = 280, char_width = 0.5, seq_name = T) +
  geom_seqlogo() +
  geom_msaBar()

p
```

```{r}
p <- ggmsa(Biostrings::readAAStringSet(aligned_prots), start = 221, end = 280, char_width = 0.5, seq_name = T) +
  geom_seqlogo() +
  geom_msaBar()

p
```

```{r}
ggseqlogo(aligned_prots)
```


## Mouse transcripts

### Transcript annotations for gene

```{r}
mouse_symbol <- homologene(params$gene_symbol, inTax = 9606, outTax = 10090)
Tx_m <- transcripts(mmdb, filter = GeneNameFilter(mouse_symbol))
txm_df <- as.data.frame(Tx_m)

datatable(txm_df)
```

### Zebrafish

```{r}
danio_symbol <- homologene(params$gene_symbol, inTax = 9606, outTax = 7955)
bsg <- BSgenome.Drerio.UCSC.danRer10

extractTranscriptSeqs(bsg, gene_models)
```

### Drosophila

```{r}
drosi_symbol <- homologene(params$gene_symbol, inTax = 9606, outTax = 7227)
bsg <- BSgenome.Drerio.UCSC.danRer10

extractTranscriptSeqs(bsg, gene_models)
```

